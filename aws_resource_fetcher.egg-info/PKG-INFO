Metadata-Version: 2.4
Name: aws-resource-fetcher
Version: 0.1.0
Summary: AWS 리소스 조회 시스템 - EC2, VPC, 보안그룹 정보 수집
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: boto3>=1.34.0
Requires-Dist: fastapi>=0.123.0
Requires-Dist: uvicorn[standard]>=0.38.0
Provides-Extra: dev
Requires-Dist: pytest>=7.4.0; extra == "dev"
Requires-Dist: hypothesis>=6.92.0; extra == "dev"
Requires-Dist: moto>=4.2.0; extra == "dev"
Requires-Dist: mypy>=1.7.0; extra == "dev"
Requires-Dist: boto3-stubs[ec2,sts]>=1.34.0; extra == "dev"

# AWS Resource Fetcher

**프로젝트 다빈치 (Da Vinci)** - AWS 리소스 조회 및 다이어그램 생성 시스템

AWS 계정의 EC2, VPC, 보안그룹 정보를 자동으로 수집하여 JSON 형태로 제공하는 Python 라이브러리입니다.

## 주요 기능

- ✅ CrossAccount AssumeRole을 통한 다중 계정 접근
- ✅ EC2 인스턴스, VPC, 보안그룹 정보 수집
- ✅ 구조화된 JSON 형태로 결과 반환
- ✅ 명확한 에러 처리 및 부분 실패 지원

## 빠른 시작

### 1. 설치

```bash
# uv 패키지 관리자 설치 (처음 사용하는 경우)
curl -LsSf https://astral.sh/uv/install.sh | sh

# 프로젝트 의존성 설치
uv sync
```

### 2. AWS 자격증명 설정

AWS CLI 자격증명이 설정되어 있어야 합니다:

```bash
# AWS 자격증명 확인
aws sts get-caller-identity

# 자격증명이 없다면 설정
aws configure
```

### 3. 기본 사용법

Python 스크립트 작성 (`example.py`):

```python
from aws_resource_fetcher.resource_fetcher import ResourceFetcher

fetcher = ResourceFetcher()
result = fetcher.fetch_all_resources(
    account_id="123456789012",
    role_name="CrossAccountReadRole",
    region="ap-northeast-2"
)

print(f"EC2 인스턴스: {len(result['ec2_instances'])}개")
print(f"VPC: {len(result['vpcs'])}개")
print(f"보안그룹: {len(result['security_groups'])}개")
```

실행:

```bash
uv run python example.py
```

## 사용 예시

### 전체 리소스 조회

```bash
# Python 인터프리터 실행
uv run python

# 다음 명령어 입력
>>> from aws_resource_fetcher.resource_fetcher import ResourceFetcher
>>> fetcher = ResourceFetcher()
>>> result = fetcher.fetch_all_resources(
...     account_id="123456789012",
...     role_name="CrossAccountReadRole"
... )
>>> print(result.keys())
dict_keys(['account_id', 'region', 'timestamp', 'ec2_instances', 'vpcs', 'security_groups'])
```

### EC2 인스턴스만 조회

```bash
uv run python

>>> from aws_resource_fetcher.credentials import AWSCredentialManager
>>> from aws_resource_fetcher.fetchers.ec2 import EC2Fetcher
>>> 
>>> manager = AWSCredentialManager()
>>> creds = manager.assume_role("123456789012", "CrossAccountReadRole")
>>> 
>>> fetcher = EC2Fetcher()
>>> instances = fetcher.fetch(creds, "ap-northeast-2")
>>> print(f"조회된 인스턴스: {len(instances)}개")
```

### VPC 정보 조회

```bash
uv run python

>>> from aws_resource_fetcher.credentials import AWSCredentialManager
>>> from aws_resource_fetcher.fetchers.vpc import VPCFetcher
>>> 
>>> manager = AWSCredentialManager()
>>> creds = manager.assume_role("123456789012", "CrossAccountReadRole")
>>> 
>>> fetcher = VPCFetcher()
>>> vpcs = fetcher.fetch(creds, "ap-northeast-2")
>>> for vpc in vpcs:
...     print(f"{vpc.name}: {vpc.cidr_block}")
```

### 보안그룹 조회

```bash
uv run python

>>> from aws_resource_fetcher.credentials import AWSCredentialManager
>>> from aws_resource_fetcher.fetchers.security_group import SecurityGroupFetcher
>>> 
>>> manager = AWSCredentialManager()
>>> creds = manager.assume_role("123456789012", "CrossAccountReadRole")
>>> 
>>> fetcher = SecurityGroupFetcher()
>>> sgs = fetcher.fetch(creds, "ap-northeast-2")
>>> for sg in sgs:
...     print(f"{sg.name}: {len(sg.inbound_rules)}개 인바운드 규칙")
```

## 결과 데이터 구조

조회 결과는 다음과 같은 구조를 가집니다:

```
{
  "account_id": "계정 번호",
  "region": "리전 이름",
  "timestamp": "조회 시간",
  "ec2_instances": [
    {
      "instance_id": "인스턴스 ID",
      "name": "인스턴스 이름",
      "state": "상태 (running, stopped 등)",
      "vpc_id": "VPC ID",
      "subnet_id": "서브넷 ID",
      "security_groups": ["보안그룹 ID 목록"],
      "private_ip": "프라이빗 IP",
      "public_ip": "퍼블릭 IP (없으면 null)"
    }
  ],
  "vpcs": [
    {
      "vpc_id": "VPC ID",
      "name": "VPC 이름",
      "cidr_block": "CIDR 블록",
      "subnets": [
        {
          "subnet_id": "서브넷 ID",
          "name": "서브넷 이름",
          "cidr_block": "CIDR 블록",
          "availability_zone": "가용 영역"
        }
      ]
    }
  ],
  "security_groups": [
    {
      "group_id": "보안그룹 ID",
      "name": "보안그룹 이름",
      "vpc_id": "VPC ID",
      "description": "설명",
      "inbound_rules": [규칙 목록],
      "outbound_rules": [규칙 목록]
    }
  ]
}
```

## 필요한 IAM 권한

대상 AWS 계정의 CrossAccount Role에 다음 권한이 필요합니다:

```
- ec2:DescribeInstances
- ec2:DescribeVpcs
- ec2:DescribeSubnets
- ec2:DescribeSecurityGroups
```

## 개발 가이드

### 테스트 실행

```bash
# 전체 테스트 실행
uv run pytest

# 상세 출력 모드
uv run pytest -v

# 특정 테스트만 실행
uv run pytest tests/test_resource_fetcher.py

# Property-based 테스트만 실행
uv run pytest tests/property_tests/

# 엔드투엔드 통합 테스트만 실행
uv run pytest tests/test_e2e_integration.py
```

### 타입 체킹

```bash
# 전체 타입 체킹
uv run mypy aws_resource_fetcher/

# Strict 모드
uv run mypy aws_resource_fetcher/ --strict
```

### 코드 커버리지 확인

```bash
# 커버리지 측정
uv run pytest --cov=aws_resource_fetcher

# HTML 리포트 생성
uv run pytest --cov=aws_resource_fetcher --cov-report=html
```

## 에러 처리

시스템은 다음과 같은 에러를 명확하게 구분합니다:

- **AssumeRoleError**: Role assume 실패 (잘못된 계정 번호, Role 이름 등)
- **PermissionError**: 권한 부족 (필요한 IAM 권한 없음)
- **ResourceFetchError**: 리소스 조회 실패 (네트워크 에러, API 에러 등)

에러 발생 시 원인과 해결 방법이 포함된 메시지가 제공됩니다.

## 기술 스택

- **Python 3.11+**: 최신 타입 힌트 지원
- **boto3**: AWS SDK
- **pytest**: 테스트 프레임워크
- **hypothesis**: Property-based testing
- **moto**: AWS 서비스 모킹
- **mypy**: 정적 타입 체킹
- **uv**: 빠른 Python 패키지 관리

## 프로젝트 구조

```
aws_resource_fetcher/
├── credentials.py          # AWS 자격증명 관리
├── exceptions.py           # 커스텀 예외
├── models.py              # 데이터 모델
├── resource_fetcher.py    # 통합 조회 인터페이스
└── fetchers/
    ├── base.py            # 기본 Fetcher 클래스
    ├── ec2.py             # EC2 조회
    ├── vpc.py             # VPC 조회
    └── security_group.py  # 보안그룹 조회

tests/
├── test_credentials.py           # 자격증명 테스트
├── test_resource_fetcher.py      # 통합 테스트
├── test_e2e_integration.py       # 엔드투엔드 테스트
├── test_fetchers/                # Fetcher별 테스트
└── property_tests/               # Property-based 테스트
```

## 문제 해결

### "uv: command not found" 에러

```bash
# uv 재설치
curl -LsSf https://astral.sh/uv/install.sh | sh

# 쉘 재시작
source ~/.bashrc  # 또는 source ~/.zshrc
```

### "No credentials found" 에러

```bash
# AWS 자격증명 설정
aws configure

# 또는 환경 변수 설정
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"
```

### "AccessDenied" 에러

대상 계정의 IAM Role에 필요한 권한이 있는지 확인하세요:
- ec2:DescribeInstances
- ec2:DescribeVpcs
- ec2:DescribeSubnets
- ec2:DescribeSecurityGroups

## 라이선스

Saltware Cloud 사업부 내부 프로젝트

## 기여

Saltware Cloud 사업부 엔지니어들의 기여를 환영합니다.
